# AppMetrica Events - QR Scanner

Документация по событиям AppMetrica для функционала сканирования QR-кодов.

## События экрана сканирования

### 1. `scan_screen_opened`
**Описание:** Открытие экрана сканирования QR-кода

**Параметры:**
- `is_premium` (Bool): Имеет ли пользователь премиум подписку
- `remaining_scans` (Int, опционально): Количество оставшихся бесплатных сканов (только для free пользователей)

**Когда логируется:** При открытии экрана `ScanQRScreenNew` (в `.onAppear`)

---

### 2. `qr_scan_success`
**Описание:** Успешное сканирование QR-кода

**Параметры:**
- `qr_type` (String): Тип QR-кода ("url", "email", "phone", "text")
- `scan_source` (String): Источник сканирования ("camera" или "gallery")
- `is_premium` (Bool): Имеет ли пользователь премиум подписку
- `remaining_scans` (Int, опционально): Количество оставшихся бесплатных сканов после этого сканирования

**Когда логируется:** При успешном распознавании QR-кода из любого источника

---

### 3. `qr_scanned`
**Описание:** Событие сканирования QR-кода (старое, для совместимости)

**Параметры:**
- `qr_type` (String): Тип QR-кода ("url", "email", "phone", "text")
- `is_premium` (Bool): Имеет ли пользователь премиум подписку

**Когда логируется:** При успешном распознавании QR-кода (логируется вместе с `qr_scan_success`)

---

### 4. `qr_scan_from_camera`
**Описание:** Сканирование QR-кода с помощью камеры

**Параметры:**
- `qr_type` (String): Тип QR-кода ("url", "email", "phone", "text")
- `is_premium` (Bool): Имеет ли пользователь премиум подписку

**Когда логируется:** При успешном сканировании QR-кода через камеру

---

### 5. `qr_scan_from_gallery`
**Описание:** Сканирование QR-кода из галереи

**Параметры:**
- `qr_type` (String): Тип QR-кода ("url", "email", "phone", "text")
- `is_premium` (Bool): Имеет ли пользователь премиум подписку
- `multiple_detected` (Bool): Было ли обнаружено несколько QR-кодов на изображении

**Когда логируется:** При успешном сканировании QR-кода из выбранного изображения

---

### 6. `qr_scan_multiple_detected`
**Описание:** Обнаружено несколько QR-кодов на одном изображении

**Параметры:**
- `qr_count` (Int): Количество обнаруженных QR-кодов
- `is_premium` (Bool): Имеет ли пользователь премиум подписку

**Когда логируется:** Когда на выбранном изображении найдено более одного QR-кода

---

### 7. `qr_scan_failed`
**Описание:** Неудачная попытка сканирования (QR-код не найден)

**Параметры:**
- `scan_source` (String): Источник сканирования ("camera" или "gallery")
- `is_premium` (Bool): Имеет ли пользователь премиум подписку

**Когда логируется:** Когда на выбранном изображении не найдено ни одного QR-кода

---

## События взаимодействия с интерфейсом

### 8. `flash_toggled`
**Описание:** Переключение вспышки камеры

**Параметры:**
- `enabled` (Bool): Включена ли вспышка после переключения
- `is_premium` (Bool): Имеет ли пользователь премиум подписку

**Когда логируется:** При нажатии кнопки Flash на экране сканирования

---

### 9. `camera_switched`
**Описание:** Переключение между передней и задней камерой

**Параметры:**
- `camera_position` (String): Позиция камеры после переключения ("front" или "back")
- `is_premium` (Bool): Имеет ли пользователь премиум подписку

**Когда логируется:** При нажатии кнопки Switch на экране сканирования

---

### 10. `gallery_opened`
**Описание:** Открытие галереи для выбора изображения

**Параметры:**
- `is_premium` (Bool): Имеет ли пользователь премиум подписку

**Когда логируется:** При выборе изображения через PhotosPicker (когда `selectedPhotoItem` изменяется)

---

## События лимитов и монетизации

### 11. `scan_limit_reached`
**Описание:** Достижение лимита бесплатных сканирований

**Параметры:** Нет

**Когда логируется:** Когда бесплатный пользователь исчерпал все 5 бесплатных сканов

---

### 12. `last_scan_warning_shown`
**Описание:** Показано предупреждение о последнем бесплатном скане

**Параметры:**
- `is_premium` (Bool): Имеет ли пользователь премиум подписку

**Когда логируется:** Когда у пользователя остался 1 бесплатный скан и показывается алерт

---

### 13. `last_scan_warning_upgrade_clicked`
**Описание:** Нажатие кнопки "Get Unlimited" в предупреждении о последнем скане

**Параметры:** Нет

**Когда логируется:** При нажатии кнопки "Get Unlimited" в алерте о последнем бесплатном скане

---

### 14. `paywall_shown_from_scan_limit`
**Описание:** Показ paywall из-за достижения лимита сканирований

**Параметры:** Нет

**Когда логируется:** При нажатии на блок "Free scan limit reached" для открытия paywall

---

### 15. `ad_watched`
**Описание:** Просмотр рекламы для получения бесплатного скана

**Параметры:**
- `ad_type` (String): Тип рекламы ("rewarded")
- `reward` (String, опционально): Награда за просмотр ("free_scan")

**Когда логируется:** После успешного просмотра rewarded рекламы для получения бесплатного скана

---

## Схема пользовательского пути

### Бесплатный пользователь:

1. **Открытие экрана** → `scan_screen_opened` (remaining_scans: 5)
2. **Сканирование** → `qr_scan_success`, `qr_scanned`, `qr_scan_from_camera`
3. **После 4 сканов** → `last_scan_warning_shown`
4. **5-е сканирование** → `scan_limit_reached`
5. **Просмотр рекламы** → `ad_watched` (reward: "free_scan")
6. **Или клик на paywall** → `paywall_shown_from_scan_limit`

### Премиум пользователь:

1. **Открытие экрана** → `scan_screen_opened` (без remaining_scans)
2. **Сканирование** → `qr_scan_success`, `qr_scanned`, `qr_scan_from_camera`
3. **Без ограничений** → Продолжает сканировать

---

## Примеры использования в аналитике

### Конверсия в премиум:
- Отслеживать путь: `scan_limit_reached` → `paywall_shown_from_scan_limit` → `subscription_purchased`
- Отслеживать путь: `last_scan_warning_shown` → `last_scan_warning_upgrade_clicked` → `subscription_purchased`

### Эффективность rewarded рекламы:
- Количество просмотров: `ad_watched` (reward: "free_scan")
- Дополнительные сканы после рекламы: `qr_scan_success` (is_premium: false, после `ad_watched`)

### Популярность источников сканирования:
- Камера: подсчет `qr_scan_from_camera`
- Галерея: подсчет `qr_scan_from_gallery`
- Процент успешных сканов из галереи: `qr_scan_from_gallery` / (`qr_scan_from_gallery` + `qr_scan_failed`)

### Типы QR-кодов:
- Распределение по типам: анализ параметра `qr_type` в событиях `qr_scan_success`
- URL vs Email vs Phone vs Text

---

## Интеграция с другими системами

Все события также можно передавать в AppsFlyer через attribution в AppMetrica:
```swift
AppMetrica.reportExternalAttribution(data, from: .appsflyer)
```

Для настройки воронок в AppMetrica рекомендуется использовать следующую последовательность:
1. `scan_screen_opened`
2. `qr_scan_success` / `qr_scan_failed`
3. `scan_limit_reached` (для free пользователей)
4. `paywall_shown_from_scan_limit`
5. `subscription_purchased`
